{{ define "main" }}
{{ $avatar := "" }}
{{ with .Resources.GetMatch "avatar*" }}{{ $avatar = .RelPermalink }}{{ end }}
{{ $socialEmail := "" }}
{{ range .Params.social }}
  {{ if and (eq .icon "envelope") (hasPrefix .link "mailto:") }}
    {{ $socialEmail = replace .link "mailto:" "" }}
  {{ end }}
{{ end }}
{{ $email := .Params.email | default $socialEmail }}
{{ $recent := first 6 (.Pages.ByDate.Reverse) }}
{{ $workCount := len .Pages }}
{{ $matchedPubs := slice }}
{{ range $pub := (where site.RegularPages "Section" "publication") }}
  {{ $hit := false }}
  {{ with $pub.Params.authors }}
    {{ range . }}
      {{ if not $hit }}
        {{ $resolved := partial "content/resolve_author_profile" (dict "name" .) }}
        {{ with index $resolved "page" }}
          {{ if eq .RelPermalink $.RelPermalink }}
            {{ $hit = true }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ if $hit }}
    {{ $matchedPubs = $matchedPubs | append $pub }}
  {{ end }}
{{ end }}
{{ if gt (len $matchedPubs) 0 }}
  {{ $workCount = len $matchedPubs }}
  {{ $recent = first 6 (sort $matchedPubs "Date" "desc") }}
{{ end }}
{{ $social := .Params.social | default (slice) }}

<div class="universal-wrapper">
  <section class="macs-author-fancy">
    <header class="macs-author-hero">
      <div class="macs-author-visual">
        {{ if $avatar }}
          <img src="{{ $avatar }}" alt="{{ .Title }} avatar" class="macs-author-avatar">
        {{ else }}
          <div class="macs-author-avatar placeholder">{{ slicestr .Title 0 1 }}</div>
        {{ end }}
      </div>

      <div class="macs-author-head-copy">
        <p class="kicker">MACS LAB PROFILE</p>
        <h1>
          <span class="name-ko">{{ if .Params.name_ko }}{{ .Params.name_ko }}{{ else }}{{ .Title }}{{ end }}</span>{{ with .Params.name_en }} <span class="name-en">({{ . }})</span>{{ end }}
        </h1>
        <div class="macs-author-meta-line">
          <p class="role">{{ .Params.role }}</p>
          {{ with index .Params.organizations 0 }}
            <p class="org">{{ .name }}</p>
          {{ end }}
        </div>
        {{ if ne $email "" }}
          <p class="contact">Contact: <a href="mailto:{{ $email }}">{{ $email }}</a></p>
        {{ end }}
        <div class="macs-author-stat-row">
          <span>Interests {{ len (.Params.interests | default (slice)) }}</span>
          <span>Courses {{ len (.Params.education.courses | default (slice)) }}</span>
          <span>Works {{ $workCount }}</span>
        </div>
      </div>
    </header>

    <div class="macs-author-main">
      <div class="macs-author-col-left">
        {{ with .Params.education.courses }}
          <section class="macs-author-block">
            <h2>Education</h2>
            <div class="macs-author-edu-list">
              {{ range . }}
                <article class="macs-author-edu-item">
                  <h3>{{ .course }}</h3>
                  <p>{{ .institution }}</p>
                  <small>{{ .year }}</small>
                </article>
              {{ end }}
            </div>
          </section>
        {{ end }}

        {{ if .Content }}
          <section class="macs-author-block">
            <h2>Bio</h2>
            <div class="macs-author-bio">
              {{ .Content }}
            </div>
          </section>
        {{ end }}

      </div>

      <div class="macs-author-col-right">
        {{ if gt (len $social) 0 }}
          <section class="macs-author-block">
            <h2>Link</h2>
            <div class="macs-author-links">
              {{ range $social }}
                {{ $pack := .icon_pack | default "fas" }}
                {{ $icon := .icon | default "link" }}
                {{ $klass := "" }}
                {{ if eq $pack "ai" }}
                  {{ if eq $icon "google-scholar" }}
                    {{ $klass = "ai ai-google-scholar" }}
                  {{ else if eq $icon "orcid" }}
                    {{ $klass = "ai ai-orcid" }}
                  {{ else if eq $icon "cv" }}
                    {{ $klass = "ai ai-cv" }}
                  {{ else }}
                    {{ $klass = (printf "ai ai-%s" $icon) }}
                  {{ end }}
                {{ else if eq $pack "fab" }}
                  {{ $klass = (printf "fab fa-%s" $icon) }}
                {{ else }}
                  {{ if eq $icon "envelope" }}
                    {{ $klass = "fas fa-envelope" }}
                  {{ else }}
                    {{ $klass = (printf "fas fa-%s" $icon) }}
                  {{ end }}
                {{ end }}
                <a href="{{ .link }}"
                   aria-label="{{ $icon }}"
                   title="{{ $icon }}"
                   {{ if not (hasPrefix .link "mailto:") }}target="_blank" rel="noopener"{{ end }}>
                  <i class="{{ $klass }}" aria-hidden="true"></i>
                </a>
              {{ end }}
            </div>
          </section>
        {{ end }}

        {{ if .Params.interests }}
          <section class="macs-author-block">
            <h2>Research Interest</h2>
            <div class="macs-chip-wrap">
              {{ range .Params.interests }}
                <span class="chip">{{ . }}</span>
              {{ end }}
            </div>
          </section>
        {{ end }}

        {{ if gt (len $recent) 0 }}
          <section class="macs-author-block">
            <h2>Recent Work</h2>
            <div class="macs-author-work-list">
              {{ range $recent }}
                <a class="work-item" href="{{ .RelPermalink }}">
                  <span class="type">{{ .Type }}</span>
                  <strong>{{ .Title }}</strong>
                  <small>{{ .Date.Format "2006-01-02" }}</small>
                </a>
              {{ end }}
            </div>
          </section>
        {{ end }}
      </div>
    </div>
  </section>
</div>
{{ end }}
