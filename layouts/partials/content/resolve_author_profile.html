{{- $name := trim (.name | default "") " \n\r\t" -}}
{{- $norm := lower (replaceRE "[^\\pL\\pN]" "" $name) -}}
{{- $profile := site.GetPage (printf "authors/%s" $name) -}}
{{- if not $profile -}}
  {{- $profile = site.GetPage (printf "authors/%s" (urlize $name)) -}}
{{- end -}}
{{- if and $profile (not $profile.File) -}}
  {{- $profile = false -}}
{{- end -}}

{{- $alias := dict
  "kyungsulee" "이경수"
  "seoyeonchoi" "최서연"
  "seoyeonchoistudentresearcher학부연구생" "최서연"
  "yeongsukim" "김영수"
  "youngsukim" "김영수"
  "dongjunkang" "강동준"
  "saganghong" "홍사강"
  "geonhahong" "홍건하"
  "suminkim" "김수민"
  "junholee" "이준호"
  "donghyeonlee" "이동현"
  "donghyunlee" "이동현"
  "jinyeongjeong" "정진영"
  "sejinjeong" "정세진"
  "jinseonlee" "이진선"
  "hongseokchoi" "최홍석"
  "jaehunbae" "배재훈"
  "sangaahn" "안상아"
-}}

{{- if not $profile -}}
  {{- with index $alias $norm -}}
    {{- $profile = site.GetPage (printf "authors/%s" .) -}}
    {{- if not $profile -}}
      {{- $profile = site.GetPage (printf "authors/%s" (urlize .)) -}}
    {{- end -}}
    {{- if and $profile (not $profile.File) -}}
      {{- $profile = false -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if not $profile -}}
  {{- $heuristic := "" -}}
  {{- if in $norm "kyungsulee" -}}
    {{- $heuristic = "이경수" -}}
  {{- else if in $norm "seoyeonchoi" -}}
    {{- $heuristic = "최서연" -}}
  {{- end -}}
  {{- if ne $heuristic "" -}}
    {{- $profile = site.GetPage (printf "authors/%s" $heuristic) -}}
    {{- if not $profile -}}
      {{- $profile = site.GetPage (printf "authors/%s" (urlize $heuristic)) -}}
    {{- end -}}
    {{- if and $profile (not $profile.File) -}}
      {{- $profile = false -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if not $profile -}}
  {{- $allAuthors := slice -}}
  {{- range site.Pages -}}
    {{- if and .File (or (eq .Type "authors") (eq .Section "authors")) (or (eq .Kind "term") (eq .Kind "page")) -}}
      {{- $allAuthors = $allAuthors | append . -}}
    {{- end -}}
  {{- end -}}
  {{- $preferred := slice -}}
  {{- $fallback := slice -}}
  {{- range $a := $allAuthors -}}
    {{- if and $a.File (eq $a.File.ContentBaseName "admin") -}}
      {{- $fallback = $fallback | append $a -}}
    {{- else -}}
      {{- $preferred = $preferred | append $a -}}
    {{- end -}}
  {{- end -}}
  {{- $ordered := $preferred | append $fallback -}}
  {{- range $a := $ordered -}}
    {{- if not $profile -}}
      {{- $titleNorm := lower (replaceRE "[^\\pL\\pN]" "" ($a.Title | default "")) -}}
      {{- $koNorm := lower (replaceRE "[^\\pL\\pN]" "" (($a.Params.name_ko) | default "")) -}}
      {{- $enNorm := lower (replaceRE "[^\\pL\\pN]" "" (($a.Params.name_en) | default "")) -}}
      {{- $slugNorm := "" -}}
      {{- with $a.File -}}{{- $slugNorm = lower (replaceRE "[^\\pL\\pN]" "" (.ContentBaseName | default "")) -}}{{- end -}}
      {{- $first := trim (($a.Params.first_name) | default "") " " -}}
      {{- $last := trim (($a.Params.last_name) | default "") " " -}}
      {{- $firstNorm := lower (replaceRE "[^\\pL\\pN]" "" $first) -}}
      {{- $lastNorm := lower (replaceRE "[^\\pL\\pN]" "" $last) -}}
      {{- $fullNorm := "" -}}
      {{- if and (ne $firstNorm "") (ne $lastNorm "") (not (eq $firstNorm "student")) (not (eq $lastNorm "1")) -}}
        {{- $fullNorm = printf "%s%s" $firstNorm $lastNorm -}}
      {{- end -}}
      {{- if or
        (and (ne $titleNorm "") (eq $norm $titleNorm))
        (and (ne $koNorm "") (eq $norm $koNorm))
        (and (ne $enNorm "") (eq $norm $enNorm))
        (and (ne $slugNorm "") (eq $norm $slugNorm))
        (and (ne $fullNorm "") (eq $norm $fullNorm))
      -}}
        {{- $profile = $a -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $display := $name -}}
{{- $url := "" -}}
{{- if $profile -}}
  {{- with $profile.Params.name_en -}}
    {{- if ne (trim . " ") "" -}}{{- $display = . -}}{{- end -}}
  {{- else -}}
    {{- with $profile.Params.name_ko -}}
      {{- if ne (trim . " ") "" -}}{{- $display = . -}}{{- else -}}{{- $display = $profile.Title -}}{{- end -}}
    {{- else -}}
      {{- $display = $profile.Title -}}
    {{- end -}}
  {{- end -}}
  {{- $url = $profile.RelPermalink -}}
{{- end -}}

{{- return (dict "page" $profile "display" $display "url" $url "raw" $name) -}}
